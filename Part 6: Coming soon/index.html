
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../Part%205%3A%20Write%20your%20Kubernetes%20Infrastructure%20as%20Go%20code%20-%20Manage%20AWS%20services/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.3">
    
    
      
        <title>Write your Kubernetes Infrastructure as Go code - Combine cdk8s with AWS CDK - Write your Kubernetes Infrastructure as Go code</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6b71719e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prerequisites" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Write your Kubernetes Infrastructure as Go code" class="md-header__button md-logo" aria-label="Write your Kubernetes Infrastructure as Go code" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Write your Kubernetes Infrastructure as Go code
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Write your Kubernetes Infrastructure as Go code - Combine cdk8s with AWS CDK
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Write your Kubernetes Infrastructure as Go code" class="md-nav__button md-logo" aria-label="Write your Kubernetes Infrastructure as Go code" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Write your Kubernetes Infrastructure as Go code
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome!
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="false">
          Part 1: Getting started with cdk8s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 1: Getting started with cdk8s" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Part 1: Getting started with cdk8s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Part%201%3A%20Getting%20started%20with%20cdk8s/" class="md-nav__link">
        Getting started with cdk8s
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" tabindex="0" aria-expanded="false">
          Part 2: cdk8s plus in action
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 2: cdk8s plus in action" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Part 2: cdk8s plus in action
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Part%202%3A%20cdk8s-plus%20in%20action/" class="md-nav__link">
        cdk8s-plus in action!
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" tabindex="0" aria-expanded="false">
          Part 3: Using Custom Resource Definitions with cdk8s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 3: Using Custom Resource Definitions with cdk8s" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Part 3: Using Custom Resource Definitions with cdk8s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Part%203%3A%20Using%20Custom%20Resource%20Definitions%20with%20cdk8s/" class="md-nav__link">
        Using Custom Resource Definitions with cdk8s
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" tabindex="0" aria-expanded="false">
          Part 4: Extend cdk8s with custom Constructs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 4: Extend cdk8s with custom Constructs" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Part 4: Extend cdk8s with custom Constructs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Part%204%3A%20Extend%20cdk8s%20with%20custom%20Constructs/" class="md-nav__link">
        Extend cdk8s with custom Constructs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" tabindex="0" aria-expanded="false">
          Part 5: Write your Kubernetes Infrastructure as Go code   Manage AWS services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 5: Write your Kubernetes Infrastructure as Go code   Manage AWS services" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Part 5: Write your Kubernetes Infrastructure as Go code   Manage AWS services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Part%205%3A%20Write%20your%20Kubernetes%20Infrastructure%20as%20Go%20code%20-%20Manage%20AWS%20services/" class="md-nav__link">
        Write your Kubernetes Infrastructure as Go code - Manage AWS services
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_7" tabindex="0" aria-expanded="true">
          Part 6: Coming soon
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Part 6: Coming soon" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Part 6: Coming soon
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Write your Kubernetes Infrastructure as Go code - Combine cdk8s with AWS CDK
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Write your Kubernetes Infrastructure as Go code - Combine cdk8s with AWS CDK
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-it-simple-with-nginx-on-eks" class="md-nav__link">
    Keeping it simple with Nginx on EKS
  </a>
  
    <nav class="md-nav" aria-label="Keeping it simple with Nginx on EKS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#behind-the-scenes" class="md-nav__link">
    Behind the scenes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-on-kubernetes-the-hard-way" class="md-nav__link">
    Nginx on Kubernetes, the hard way!
  </a>
  
    <nav class="md-nav" aria-label="Nginx on Kubernetes, the hard way!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#is-there-a-better-way" class="md-nav__link">
    Is there a better way..?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-example-dynamodb-along-with-an-application-on-eks" class="md-nav__link">
    End to end example: DynamoDB along with an application on EKS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-up" class="md-nav__link">
    Wrap up
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-it-simple-with-nginx-on-eks" class="md-nav__link">
    Keeping it simple with Nginx on EKS
  </a>
  
    <nav class="md-nav" aria-label="Keeping it simple with Nginx on EKS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#behind-the-scenes" class="md-nav__link">
    Behind the scenes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-on-kubernetes-the-hard-way" class="md-nav__link">
    Nginx on Kubernetes, the hard way!
  </a>
  
    <nav class="md-nav" aria-label="Nginx on Kubernetes, the hard way!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#is-there-a-better-way" class="md-nav__link">
    Is there a better way..?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-example-dynamodb-along-with-an-application-on-eks" class="md-nav__link">
    End to end example: DynamoDB along with an application on EKS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-up" class="md-nav__link">
    Wrap up
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Write your Kubernetes Infrastructure as Go code - Combine cdk8s with AWS CDK</h1>

<p>In an <a href="../Part%205%3A%20Write%20your%20Kubernetes%20Infrastructure%20as%20Go%20code%20-%20Manage%20AWS%20services/">earlier blog post</a> with <a href="https://aws-controllers-k8s.github.io/community/docs/community/overview/">AWS Controllers for Kubernetes</a> (also known as <strong>ACK</strong>), thanks to the fact that you can import existing Kubernetes Custom Resource Definitions using <code>cdk8s</code>! This made is possible to deploy <code>DynamoDB</code> along with a client application, from  using <code>cdk8s</code> and Kubernetes.</p>
<p>But, what if you continue using <a href="https://docs.aws.amazon.com/cdk/v2/guide/home.html">AWS CDK</a> for AWS infrastructure and harness the power <code>cdk8s</code> (and <code>cdk8s-plus</code>!) to define Kubernetes resources using regular code? Thanks to the <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks-readme.html#cdk8s-charts">native integration between
the AWS EKS module and cdk8s</a>, you can have the best of both worlds! </p>
<p>The goal of this blog post is to demonstrate that with a few examples. We will start off with a simple (nginx based) example before moving on to a full-fledged application stack (including <code>DynamoDB</code> etc.). Both will be using the Go programming language which is well supported in <a href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html">AWS CDK</a> as well as <a href="https://cdk8s.io/docs/latest/getting-started/#prerequisites">cdk8s</a>.</p>
<blockquote>
<p>All the code discussed in this blog is available in <a href="https://github.com/abhirockzz/cdk8s-for-go-developers/tree/master/part6-cdk-eks-cdk8s">this GitHub repo</a></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<p>To follow along step-by-step, in addition to an AWS account, you will need following CLIs - <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a>, <a href="https://cdk8s.io/docs/latest/getting-started/#install-the-cli">cdk8s CLI</a> and <a href="https://kubernetes.io/docs/tasks/tools/#kubectl">kubectl</a>. Also, dont' forget to install <a href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install">AWS CDK</a>, the <a href="https://go.dev/dl/">Go programming language</a> (v1.16 or above) as well as <a href="https://docs.docker.com/engine/install/">Docker</a>, if you don't have them already.</p>
<h2 id="keeping-it-simple-with-nginx-on-eks">Keeping it simple with Nginx on EKS</h2>
<p>As with most things in life, there are two ways - the easy way or the hard way ;) You will see both of them! Let's try things out first, see them working and then look at the code.</p>
<p>To start off, clone the repo and change to the right directory:</p>
<pre><code class="language-bash">git clone https://github.com/abhirockzz/cdk8s-for-go-developers
cd cdk8s-for-go-developers/part6-cdk-eks-cdk8s/cdk-cdk8s-nginx-eks
</code></pre>
<p>To setup everything, all you need is a single command:</p>
<pre><code class="language-bash">cdk deploy
</code></pre>
<blockquote>
<p>you can also use <code>cdk synth</code> to generate and inspect the Cloud Formation template first</p>
</blockquote>
<p>You will be prompted to confirm. Once you do that, the process will kick off - it will take some time since lots of AWS resources will be created, including VPC, EKS cluster etc.</p>
<blockquote>
<p>Feel free to check the AWS Cloud Formation console to track the progress.</p>
</blockquote>
<p>Once the process is complete, you need to connect to the EKS cluster using <code>kubectl</code>. The command required for this will be available as a result of the <code>cdk deploy</code> process (in the terminal) or you can refer to the <strong>Outputs</strong> section of the AWS Cloud Formation stack.</p>
<p><img alt="Image description" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kc9nqjnoy6wtxboweglv.png" /></p>
<p>Once you've configured <code>kubectl</code> to point to your EKS cluster, you can check the Nginx <code>Deployment</code> and <code>Service</code>.</p>
<pre><code class="language-bash">kubectl get deployment

# output

NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment-cdk8s        1/1     1            1           1m
nginx-deployment-cdk          1/1     1            1           1m
</code></pre>
<p>You will see that two <code>Deployment</code>s have been created - more on this soon. Similiarly, if you check the <code>Service</code> (<code>kubectl get svc</code>), you should see two of them - <code>nginx-service-cdk</code> and <code>nginx-service-cdk8s</code>.</p>
<p>To access Nginx, pick the <code>EXTERNAL-IP</code> of any of the two <code>Service</code>s. For example:</p>
<pre><code class="language-bash">APP_URL=$(kubectl get service/nginx-service-cdk -o jsonpath=&quot;{.status.loadBalancer.ingress[0].hostname}&quot;)

echo $APP_URL

# to access nginx (notice we are using port 9090)
curl -i http://$APP_URL:9090
</code></pre>
<blockquote>
<p>If you get a <code>Could not resolve host</code> error while accessing the LB URL, wait for a minute or so and re-try</p>
</blockquote>
<h3 id="behind-the-scenes">Behind the scenes</h3>
<p>Let's <a href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part6-cdk-eks-cdk8s/cdk-cdk8s-nginx-eks/main.go">look at the code</a> now - this will clarify why we have two Nginx <code>Deployment</code>s.</p>
<p>Thanks to AWS CDK, VPC creation is a one liner with <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsec2#NewVpc">awsec2.NewVpc</a> function and creating an <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awseks#NewCluster">EKS cluster</a> isn't too hard either!</p>
<pre><code class="language-go">func NewNginxOnEKSStack(scope constructs.Construct, id string, props *CdkStackProps) awscdk.Stack {
  //...
  vpc := awsec2.NewVpc(stack, jsii.String(&quot;demo-vpc&quot;), nil)

    eksSecurityGroup := awsec2.NewSecurityGroup(stack, jsii.String(&quot;eks-demo-sg&quot;),
        &amp;awsec2.SecurityGroupProps{
            Vpc:               vpc,
            SecurityGroupName: jsii.String(&quot;eks-demo-sg&quot;),
            AllowAllOutbound:  jsii.Bool(true)})

    eksCluster := awseks.NewCluster(stack, jsii.String(&quot;demo-eks&quot;),
        &amp;awseks.ClusterProps{
            ClusterName:   jsii.String(&quot;demo-eks-cluster&quot;),
            Version:       awseks.KubernetesVersion_V1_21(),
            Vpc:           vpc,
            SecurityGroup: eksSecurityGroup,
            VpcSubnets: &amp;[]*awsec2.SubnetSelection{
                {Subnets: vpc.PrivateSubnets()}},
            DefaultCapacity:         jsii.Number(2),
            DefaultCapacityInstance: awsec2.InstanceType_Of(awsec2.InstanceClass_BURSTABLE3, awsec2.InstanceSize_SMALL), DefaultCapacityType: awseks.DefaultCapacityType_NODEGROUP,
            OutputConfigCommand: jsii.Bool(true),
            EndpointAccess:      awseks.EndpointAccess_PUBLIC()})
//...
</code></pre>
<h2 id="nginx-on-kubernetes-the-hard-way">Nginx on Kubernetes, the hard way!</h2>
<p>Now we look at two different ways of creating Nginx, starting with the "hard" way. In this case, we use AWS CDK (<em>not</em> <code>cdk8s</code>) to define the <code>Deployment</code> and <code>Service</code> resources.</p>
<pre><code class="language-go">func deployNginxUsingCDK(eksCluster awseks.Cluster) {

    appLabel := map[string]*string{
        &quot;app&quot;: jsii.String(&quot;nginx-eks-cdk&quot;),
    }

    deployment := map[string]interface{}{
        &quot;apiVersion&quot;: jsii.String(&quot;apps/v1&quot;),
        &quot;kind&quot;:       jsii.String(&quot;Deployment&quot;),
        &quot;metadata&quot;: map[string]*string{
            &quot;name&quot;: jsii.String(&quot;nginx-deployment-cdk&quot;),
        },
        &quot;spec&quot;: map[string]interface{}{
            &quot;replicas&quot;: jsii.Number(1),
            &quot;selector&quot;: map[string]map[string]*string{
                &quot;matchLabels&quot;: appLabel,
            },
            &quot;template&quot;: map[string]interface{}{
                &quot;metadata&quot;: map[string]map[string]*string{
                    &quot;labels&quot;: appLabel,
                },
                &quot;spec&quot;: map[string][]map[string]interface{}{
                    &quot;containers&quot;: {
                        {
                            &quot;name&quot;:  jsii.String(&quot;nginx&quot;),
                            &quot;image&quot;: jsii.String(&quot;nginx&quot;),
                            &quot;ports&quot;: []map[string]*float64{
                                {
                                    &quot;containerPort&quot;: jsii.Number(80),
                                },
                            },
                        },
                    },
                },
            },
        },
    }

    service := map[string]interface{}{
        &quot;apiVersion&quot;: jsii.String(&quot;v1&quot;),
        &quot;kind&quot;:       jsii.String(&quot;Service&quot;),
        &quot;metadata&quot;: map[string]*string{
            &quot;name&quot;: jsii.String(&quot;nginx-service-cdk&quot;),
        },
        &quot;spec&quot;: map[string]interface{}{
            &quot;type&quot;: jsii.String(&quot;LoadBalancer&quot;),
            &quot;ports&quot;: []map[string]*float64{
                {
                    &quot;port&quot;:       jsii.Number(9090),
                    &quot;targetPort&quot;: jsii.Number(80),
                },
            },
            &quot;selector&quot;: appLabel,
        },
    }

    eksCluster.AddManifest(jsii.String(&quot;app-deployment&quot;), &amp;service, &amp;deployment)
}
</code></pre>
<p>Finally, to create this in EKS we invoke <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awseks#Cluster.AddManifest">AddManifest</a> (think of its like the programmatic equivalent of <code>kubectl apply</code>). This works, but there are a few gaps in this approach:</p>
<ul>
<li>We are not able to reap the benefits of Go which is a <em>strongly typed</em> language. That's because the API is <em>loosely</em> typed, thanks to <code>map[string]interface{}</code> everywhere. This makes it very error prone (I made a few mistakes too!)</li>
<li>The verbosity is apparent as well. It seems as if we are writing <code>YAML</code> in <code>Go</code> - not too much of an improvement!</li>
</ul>
<h3 id="is-there-a-better-way">Is there a better way..?</h3>
<p>Let's look at the second function <code>deployNginxUsingCDK8s</code> - by the name its obvious that we used <code>cdk8s</code>, not just CDK)</p>
<pre><code class="language-go">func deployNginxUsingCDK8s(eksCluster awseks.Cluster) {

    app := cdk8s.NewApp(nil)
    eksCluster.AddCdk8sChart(jsii.String(&quot;nginx-eks-chart&quot;), NewNginxChart(app, &quot;nginx-cdk8s&quot;, nil), nil)
}
</code></pre>
<p>This looks "too easy" to to be true! But it's made possible due to the inter-operability between CDK and <code>cdk8s</code>. What this implies is that, you can use <em>define</em> Kubernetes resources using <code>cdk8s</code> <code>Chart</code>s and apply them to an EKS cluster created with CDK (this makes it sort of a hybrind system). </p>
<p>The hero of our story is <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awseks#Cluster.AddCdk8sChart">AddCdk8sChart</a> function, which accepts a <a href="https://pkg.go.dev/github.com/aws/constructs-go/constructs/v10#Construct">constructs.Construct</a> (remember, <a href="https://dev.to/abhirockzz/write-your-kubernetes-infrastructure-as-go-code-getting-started-with-cdk8s-37n">everything is a construct</a>!). In this case, the <code>Construct</code> happens to be a <a href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-core-go/cdk8s/v2#Chart">cdk8s.Chart</a> thats returned by <code>NewNginxChart</code> function - so <a href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part6-cdk-eks-cdk8s/cdk-cdk8s-nginx-eks/nginx.go">lets take a look at that</a>.</p>
<pre><code class="language-go">func NewNginxChart(scope constructs.Construct, id string, props *MyChartProps) cdk8s.Chart {
  //....

    dep := cdk8splus22.NewDeployment(chart, jsii.String(&quot;nginx-deployment&quot;),
        &amp;cdk8splus22.DeploymentProps{
            Metadata: &amp;cdk8s.ApiObjectMetadata{
                Name: jsii.String(&quot;nginx-deployment-cdk8s&quot;)}})

    dep.AddContainer(&amp;cdk8splus22.ContainerProps{
        Name:  jsii.String(&quot;nginx-container&quot;),
        Image: jsii.String(&quot;nginx&quot;),
        Port:  jsii.Number(80)})

    dep.ExposeViaService(&amp;cdk8splus22.DeploymentExposeViaServiceOptions{
        Name:        jsii.String(&quot;nginx-service-cdk8s&quot;),
        ServiceType: cdk8splus22.ServiceType_LOAD_BALANCER,
        Ports: &amp;[]*cdk8splus22.ServicePort{{
            Port:       jsii.Number(9090),
            TargetPort: jsii.Number(80)}}})

    return chart
}
</code></pre>
<p>If you have worked with <code>cdk8s</code> (and Go) or read some of my previous blogs on this topic, this should look familiar - a strongly-typed, compact and expressive API! I don't even need to walk you through this since its so readable - we use <code>cdk8s-plus</code> to create a Nginx <code>Deployment</code>, add the container info and finally expose it via a <code>Service</code> so that we can access the Nginx from outside of EKS. </p>
<p>This was a simple enough example to help bring out difference between the two approaches. The next scenario is different - in addition to the EKS cluster it has DynamoDB along with a URL shortener application that will be deployed to EKS.</p>
<h2 id="end-to-end-example-dynamodb-along-with-an-application-on-eks">End to end example: DynamoDB along with an application on EKS</h2>
<p>Instead of creating a new EKS cluster from scratch, we will re-use the existing cluster created as a result of the previous example - this is a good opportunity to take a look at how you can reference an existing EKS cluster in your CDK code. As expected, we need to create <code>DynamoDB</code> table as well. </p>
<p>Just like in the previous example, let's try out the solution first. Change into the right directory first:</p>
<pre><code class="language-bash">cd part6-cdk-eks-cdk8s/cdk-cdk8s-dynamodb-app-eks
</code></pre>
<p>Since the URL shortener application has to make API calls to <code>DynamoDB</code>, we need to configure <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">IAM Roles for Service Accounts</a> (also known as <strong>IRSA</strong>).</p>
<blockquote>
<p>Refer to https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html</p>
</blockquote>
<p><strong>Define IAM roles for the application</strong></p>
<p>Start by creating a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes Service Account</a>:</p>
<pre><code class="language-bash">kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: eks-dynamodb-app-sa
EOF
</code></pre>
<blockquote>
<p>To confirm - <code>kubectl get serviceaccount/eks-dynamodb-app-sa -o yaml</code></p>
</blockquote>
<p>Set your AWS Account ID and <a href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC Identity provider</a> as environment variables:</p>
<pre><code class="language-bash">ACCOUNT_ID=$(aws sts get-caller-identity --query &quot;Account&quot; --output text)

export EKS_CLUSTER_NAME=&lt;enter cluster name&gt;
export AWS_REGION=&lt;enter region e.g. us-east-1&gt;

OIDC_PROVIDER=$(aws eks describe-cluster --name $EKS_CLUSTER_NAME --query &quot;cluster.identity.oidc.issuer&quot; --output text | sed -e &quot;s/^https:\/\///&quot;)
</code></pre>
<p>Create a JSON file with <em>Trusted Entities</em> for the role:</p>
<pre><code class="language-bash">read -r -d '' TRUST_RELATIONSHIP &lt;&lt;EOF
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Federated&quot;: &quot;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
      &quot;Condition&quot;: {
        &quot;StringEquals&quot;: {
          &quot;${OIDC_PROVIDER}:aud&quot;: &quot;sts.amazonaws.com&quot;,
          &quot;${OIDC_PROVIDER}:sub&quot;: &quot;system:serviceaccount:default:eks-dynamodb-app-sa&quot;
        }
      }
    }
  ]
}
EOF
echo &quot;${TRUST_RELATIONSHIP}&quot; &gt; trust.json
</code></pre>
<blockquote>
<p>Check - <code>cat trust.json</code></p>
</blockquote>
<p>Now, create the IAM role:</p>
<pre><code class="language-bash">export ROLE_NAME=dynamodb-app-irsa

aws iam create-role --role-name $ROLE_NAME --assume-role-policy-document file://trust.json --description &quot;IRSA for DynamoDB app on EKS&quot;
</code></pre>
<p>We will need to create and attach policy to role since we only want to allow <code>PutItem</code> and <code>GetItem</code> operations from our application. <a href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part6-cdk-eks-cdk8s/policy.json">Here is the policy JSON file</a>:</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;PutandGet&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;dynamodb:PutItem&quot;,
                &quot;dynamodb:GetItem&quot;
            ],
            &quot;Resource&quot;: &quot;arn:aws:dynamodb:*:*:table/urls&quot;
        }
    ]
}
</code></pre>
<p>Create and attach the policy to the role we just created:</p>
<pre><code class="language-bash">aws iam create-policy --policy-name dynamodb-irsa-policy --policy-document file://policy.json

aws iam attach-role-policy --role-name $ROLE_NAME --policy-arn=arn:aws:iam::&lt;enter AWS account ID&gt;:policy/dynamodb-irsa-policy
</code></pre>
<p>Finally, we need to associate the IAM role and Service Account:</p>
<pre><code class="language-bash">kubectl annotate serviceaccount -n default eks-dynamodb-app-sa eks.amazonaws.com/role-arn=arn:aws:iam::&lt;enter AWS account ID&gt;:role/dynamodb-app-irsa
</code></pre>
<p><strong>Get the EKS <code>kubectl</code> role ARN</strong></p>
<p>To <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks-readme.html#using-existing-clusters">reference existing EKS cluster</a> in AWS CDK, you need EKS cluster name and <code>kubectl</code> role ARN.</p>
<p>You can find the role ARN in the <strong>Outputs</strong> section of the AWS Cloud Formation stack.</p>
<p><img alt="Image description" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qr9kgedjvmyor0t1dhxr.png" /></p>
<p>We are ready to deploy the application using CDK. Set the required environment variables followed by <code>cdk deploy</code>:</p>
<blockquote>
<p>you can also use <code>cdk synth</code> to generate and inspect the Cloud Formation template first</p>
</blockquote>
<pre><code class="language-bash">export EKS_CLUSTER_NAME=&lt;enter name of EKS cluster&gt;
export KUBECTL_ROLE_ARN=&lt;enter kubectl role ARN&gt;
export SERVICE_ACCOUNT_NAME=eks-dynamodb-app-sa
export APP_PORT=8080
export AWS_REGION=&lt;enter region e.g. us-east-1&gt;

cdk deploy
</code></pre>
<p>CDK (and <code>cdk8s</code>) will do all the heavy lifting (we will look at the code very soon):</p>
<ul>
<li>New DynamoDB table will be created</li>
<li>The docker image for our application will be built and pushed to ECR</li>
<li>Kubernetes resources for the URL shortener application will be deployed to the existing EKS cluster</li>
</ul>
<p>Once the stack creation is complete, check the Kubernetes <code>Deployment</code> and <code>Service</code>:</p>
<pre><code class="language-bash">kubectl get deployment/dynamodb-app
kubectl get pods
kubectl get service/dynamodb-app-service
</code></pre>
<p>Testing the URL shortener service is easy. But I will not repeat it here since its already covered in [this blog](https://dev.to/abhirockzz/write-your-kubernetes-infrastructure-as-go-code-manage-aws-services-3pgi. All you need is the load balancer URL to access the service and use yout browser or <code>curl</code> to save and access URLs.</p>
<p><strong>Back to exploring Go code again</strong></p>
<p>Within the stack, we define the <code>DynamoDB</code> table (using <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsdynamodb#NewTable">awsdynamodb.NewTable</a>) along with the docker image for our application (with <a href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsecrassets#NewDockerImageAsset">awsecrassets.NewDockerImageAsset</a>)</p>
<pre><code class="language-go">func NewDynamoDBAppStack(scope constructs.Construct, id string, props *CdkStackProps) awscdk.Stack {
  //...
    table := awsdynamodb.NewTable(stack, jsii.String(&quot;dynamodb-table&quot;),
        &amp;awsdynamodb.TableProps{
            TableName: jsii.String(tableName),
            PartitionKey: &amp;awsdynamodb.Attribute{
                Name: jsii.String(dynamoDBPartitionKey),
                Type: awsdynamodb.AttributeType_STRING,
            },
            BillingMode:   awsdynamodb.BillingMode_PAY_PER_REQUEST,
            RemovalPolicy: awscdk.RemovalPolicy_DESTROY,
        })

    appDockerImage := awsecrassets.NewDockerImageAsset(stack, jsii.String(&quot;app-image&quot;),
        &amp;awsecrassets.DockerImageAssetProps{
            Directory: jsii.String(appDirectory)})
  //...
</code></pre>
<p>Then comes the interesting part where we get the reference to our exsiting EKS cluster and use <code>AddCdk8sChart</code> (just like before) to deploy the application to EKS.</p>
<pre><code class="language-go">//...
  eksCluster := awseks.Cluster_FromClusterAttributes(stack, jsii.String(&quot;existing cluster&quot;),
        &amp;awseks.ClusterAttributes{
            ClusterName:    jsii.String(eksClusterName),
            KubectlRoleArn: jsii.String(kubectlRoleARN)})

    app := cdk8s.NewApp(nil)
    appProps := NewAppChartProps(appDockerImage.ImageUri(), table.TableName())

    eksCluster.AddCdk8sChart(jsii.String(&quot;dynamodbapp-chart&quot;), NewDynamoDBAppChart(app, &quot;dynamodb-cdk8s&quot;, &amp;appProps), nil)
</code></pre>
<p>The <a href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part6-cdk-eks-cdk8s/cdk-cdk8s-dynamodb-app-eks/dynamodb_app.go#L59">NewDynamoDBAppChart function</a> defines the <code>Deployment</code> and <code>Service</code>. Unlike the earlier Nginx example which had static values, this application takes in dynamic values - specifically the <code>DynamoDB</code> table name (which is used as the container environment variable <code>TABLE_NAME</code>). Also notice the fact that we explicitly add the the name of the Kubernetes service account (for <em>IRSA</em>) that we had created in the previous step.</p>
<pre><code class="language-go">func NewDynamoDBAppChart(scope constructs.Construct, id string, props *AppChartProps) cdk8s.Chart {
  //...
    dep := cdk8splus22.NewDeployment(chart, jsii.String(&quot;dynamodb-app-deployment&quot;), &amp;cdk8splus22.DeploymentProps{
        Metadata: &amp;cdk8s.ApiObjectMetadata{
            Name: jsii.String(&quot;dynamodb-app&quot;)},
        ServiceAccount: cdk8splus22.ServiceAccount_FromServiceAccountName(
            chart,
            jsii.String(&quot;aws-irsa&quot;),
            jsii.String(props.serviceAccountName))})

    container := dep.AddContainer(//.. omitted for brevity)

    container.Env().AddVariable(jsii.String(&quot;TABLE_NAME&quot;), cdk8splus22.EnvValue_FromValue(props.tableName))
    container.Env().AddVariable(jsii.String(&quot;AWS_REGION&quot;), cdk8splus22.EnvValue_FromValue(&amp;props.region))

    dep.ExposeViaService(//.. omitted for brevity)
    return chart
}
</code></pre>
<h2 id="wrap-up">Wrap up</h2>
<p>That's all for this blog! We started off with a simple example to showcase the integration between AWS CDK and <code>cdk8s</code> and how easy it makes things (compared to just using CDK to deploy apps to EKS). Then, we moved on to explore a full fledged scenario where you deployed the infrastructure (<code>DynamoDB</code> etc.) along with the client application on EKS.</p>
<p>Happy Building!</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ba449ae6.min.js"></script>
      
    
  </body>
</html>